From 2ff4489de1f455b6de90f92b2ad077ae2fdf0669 Mon Sep 17 00:00:00 2001
From: lidongshan <lidongshan@goodix.com>
Date: Fri, 10 Dec 2021 17:45:38 +0800
Subject: [PATCH] fix-bugs-based-on-master

---
 .../adapter/khdf/liteos_m/platform/BUILD.gn   |   6 +
 kernel/liteos_m/.config                       | 171 ++++++++++++++++++
 kernel/liteos_m/.config.old                   |  14 ++
 kernel/liteos_m/config.h                      |  63 +++++++
 kernel/liteos_m/kal/BUILD.gn                  |   2 +-
 test/xts/acts/build_lite/BUILD.gn             |   4 +-
 .../hiviewdfx_lite/hilog_hal/src/dfx_hilog.c  |   2 +-
 third_party/mbedtls/library/entropy_poll.c    |  39 +---
 .../musl/porting/liteos_m/kernel/BUILD.gn     |  26 +--
 9 files changed, 276 insertions(+), 51 deletions(-)
 create mode 100644 kernel/liteos_m/.config
 create mode 100644 kernel/liteos_m/.config.old
 create mode 100755 kernel/liteos_m/config.h

diff --git a/drivers/adapter/khdf/liteos_m/platform/BUILD.gn b/drivers/adapter/khdf/liteos_m/platform/BUILD.gn
index 20fb339..eda2074 100644
--- a/drivers/adapter/khdf/liteos_m/platform/BUILD.gn
+++ b/drivers/adapter/khdf/liteos_m/platform/BUILD.gn
@@ -40,6 +40,12 @@ hdf_driver("hdf_platform_lite") {
     "$HDF_FRAMEWORKS_PATH/support/platform/src/pwm/pwm_core.c",
     "$HDF_FRAMEWORKS_PATH/support/platform/src/uart/uart_core.c",
     "$HDF_FRAMEWORKS_PATH/support/platform/src/uart/uart_if.c",
+
+    "$HDF_FRAMEWORKS_PATH/support/platform/src/fwk/platform_common.c",
+    "$HDF_FRAMEWORKS_PATH/support/platform/src/fwk/platform_device.c",
+    "$HDF_FRAMEWORKS_PATH/support/platform/src/fwk/platform_manager.c",
+    "$HDF_FRAMEWORKS_PATH/support/platform/src/fwk/platform_queue.c",
+
     "plat_common.c",
   ]
 }
diff --git a/kernel/liteos_m/.config b/kernel/liteos_m/.config
new file mode 100644
index 0000000..2bb8613
--- /dev/null
+++ b/kernel/liteos_m/.config
@@ -0,0 +1,171 @@
+
+#
+# Compiler
+#
+LOSCFG_COMPILER_GCC=y
+LOSCFG_CROSS_COMPILE="arm-none-eabi-"
+# LOSCFG_COMPILER_CLANG_LLVM is not set
+LOSCFG_COMPILE_DEBUG=y
+# LOSCFG_COMPILE_OPTIMIZE is not set
+LOSCFG_COMPILE_OPTIMIZE_SIZE=y
+# LOSCFG_COMPILE_LTO is not set
+# end of Compiler
+
+#
+# Platform
+#
+LOSCFG_PLATFORM="virt"
+LOSCFG_PRODUCT_NAME="arm_mps2_an386"
+LOSCFG_DEVICE_COMPANY="qemu"
+# LOSCFG_PLATFORM_QEMU_ARM_VIRT_CM7 is not set
+LOSCFG_PLATFORM_QEMU_ARM_VIRT_CM4=y
+# LOSCFG_PLATFORM_QEMU_RISCV32_VIRT is not set
+# LOSCFG_PLATFORM_QEMU_CSKY_SMARTL is not set
+# LOSCFG_PLATFORM_QEMU_XTENSA_ESP32 is not set
+LOSCFG_PRODUCT_QEMU_ARM_MPS2_AN386=y
+LOSCFG_ARCH_ARM=y
+LOSCFG_ARCH_ARM_AARCH32=y
+LOSCFG_ARCH_ARM_V7M=y
+LOSCFG_ARCH_ARM_VER="armv7-m"
+LOSCFG_ARCH_CORTEX_M4=y
+LOSCFG_ARCH_CPU="cortex-m4"
+
+#
+# Extra Configurations
+#
+# LOSCFG_ARCH_FPU_DISABLE is not set
+LOSCFG_IRQ_USE_STANDALONE_STACK=y
+# LOSCFG_ARCH_UNALIGNED_EXC is not set
+LOSCFG_SOC_COMPANY="goodix"
+LOSCFG_BOARD="gr5515_sk"
+LOSCFG_BOARD_GR5515_SK=y
+LOSCFG_LFS_MAX_BLOCK_COUNT=60
+LOSCFG_SOC="gr551x"
+LOSCFG_SOC_SERIES="gr551x"
+LOSCFG_NUM_IRQS=45
+LOSCFG_SYS_CLOCK_HW_CYCLES_PER_SEC=64000000
+LOSCFG_SOC_SERIES_GR551x=y
+LOSCFG_SOC_COMPANY_GOODIX=y
+LOSCFG_SOC_GR551x=y
+# LOSCFG_QUICK_START is not set
+# end of Platform
+
+#
+# Kernel
+#
+LOSCFG_KERNEL_EXTKERNEL=y
+LOSCFG_KERNEL_BACKTRACE=y
+LOSCFG_BACKTRACE_TYPE_1=y
+LOSCFG_BACKTRACE_TYPE=1
+LOSCFG_BACKTRACE_DEPTH=15
+# LOSCFG_KERNEL_CPPSUPPORT is not set
+LOSCFG_BASE_CORE_CPUP=y
+LOSCFG_KERNEL_CPUP=y
+LOSCFG_CPUP_INCLUDE_IRQ=y
+# LOSCFG_DYNLINK is not set
+LOSCFG_KERNEL_PM=y
+LOSCFG_KERNEL_PM_TASK_PTIORITY=1
+LOSCFG_KERNEL_PM_TASK_STACKSIZE=1024
+# LOSCFG_KERNEL_PM_DEBUG is not set
+LOSCFG_DEBUG_HOOK=y
+LOSCFG_PLATFORM_EXC=y
+# LOSCFG_KERNEL_TRACE is not set
+# LOSCFG_KERNEL_LMS is not set
+# end of Kernel
+
+#
+# Lib
+#
+LOSCFG_LIB_LIBC=y
+# end of Lib
+
+#
+# Compat
+#
+LOSCFG_KAL_CMSIS=y
+LOSCFG_LIBC_MUSL=y
+LOSCFG_LIBC_MUSL_FS=y
+# LOSCFG_LIBC_NEWLIB is not set
+LOSCFG_POSIX_API=y
+LOSCFG_POSIX_THREAD_API=y
+LOSCFG_POSIX_SEM_API=y
+LOSCFG_POSIX_CLOCK_API=y
+LOSCFG_POSIX_MQUEUE_API=y
+# end of Compat
+
+#
+# FileSystem
+#
+LOSCFG_FS_VFS=y
+LOSCFG_FS_LITTLEFS=y
+LOSCFG_LFS_MAX_MOUNT_SIZE=1
+# LOSCFG_FS_FAT is not set
+LOSCFG_SUPPORT_LITTLEFS=y
+# end of FileSystem
+
+#
+# Net
+#
+# LOSCFG_NET_LWIP is not set
+# end of Net
+
+#
+# Debug
+#
+LOSCFG_GDB=y
+LOSCFG_PLATFORM_ADAPT=y
+LOSCFG_ENABLE_MAGICKEY=y
+LOSCFG_THUMB=y
+# LOSCFG_SAVE_EXCINFO is not set
+LOSCFG_DEBUG_VERSION=y
+# LOSCFG_DEBUG_KERNEL is not set
+# LOSCFG_SHELL is not set
+# LOSCFG_SCHED_DEBUG is not set
+# LOSCFG_USER_INIT_DEBUG is not set
+# LOSCFG_MEM_DEBUG is not set
+# end of Debug
+
+#
+# Driver
+#
+LOSCFG_DRIVERS=y
+LOSCFG_DRIVERS_HDF=y
+LOSCFG_DRIVERS_HDF_PLATFORM=y
+LOSCFG_DRIVERS_HDF_PLATFORM_GPIO=y
+# LOSCFG_DRIVERS_HDF_PLATFORM_I2C is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_ADC is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_MMC is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_EMMC is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_PWM is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_RTC is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_SDIO is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_DMAC is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_MIPI_DSI is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_MIPI_CSI is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_HISI_SDK is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_SPI is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_I2S is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_HDMI is not set
+# LOSCFG_DRIVERS_HDF_PLATFORM_WATCHDOG is not set
+# end of Driver
+
+#
+# Security
+#
+# LOSCFG_SECURE_TRUSTZONE is not set
+# end of Security
+
+#
+# Test
+#
+# LOSCFG_KERNEL_TEST is not set
+# end of Test
+
+#
+# Stack Smashing Protector (SSP) Compiler Feature
+#
+# LOSCFG_CC_NO_STACKPROTECTOR is not set
+# LOSCFG_CC_STACKPROTECTOR is not set
+LOSCFG_CC_STACKPROTECTOR_STRONG=y
+# LOSCFG_CC_STACKPROTECTOR_ALL is not set
+# end of Stack Smashing Protector (SSP) Compiler Feature
diff --git a/kernel/liteos_m/.config.old b/kernel/liteos_m/.config.old
new file mode 100644
index 0000000..afd6e6d
--- /dev/null
+++ b/kernel/liteos_m/.config.old
@@ -0,0 +1,14 @@
+LOSCFG_COMPILE_DEBUG=y
+# LOSCFG_COMPILE_OPTIMIZE is not set
+# LOSCFG_COMPILE_LTO is not set
+LOSCFG_PLATFORM_QEMU_ARM_VIRT_CM4=y
+# LOSCFG_ARCH_UNALIGNED_EXC is not set
+LOSCFG_KERNEL_BACKTRACE=y
+LOSCFG_KERNEL_CPUP=y
+LOSCFG_PLATFORM_EXC=y
+LOSCFG_FS_LITTLEFS=y
+LOSCFG_GDB=y
+LOSCFG_THUMB=y
+LOSCFG_DRIVERS_HDF=y
+LOSCFG_DRIVERS_HDF_PLATFORM=y
+LOSCFG_DRIVERS_HDF_PLATFORM_GPIO=y
diff --git a/kernel/liteos_m/config.h b/kernel/liteos_m/config.h
new file mode 100755
index 0000000..ba481d6
--- /dev/null
+++ b/kernel/liteos_m/config.h
@@ -0,0 +1,63 @@
+#define LOSCFG_COMPILER_GCC 1
+#define LOSCFG_CROSS_COMPILE "arm-none-eabi-"
+#define LOSCFG_COMPILE_DEBUG 1
+#define LOSCFG_COMPILE_OPTIMIZE_SIZE 1
+#define LOSCFG_PLATFORM "virt"
+#define LOSCFG_PRODUCT_NAME "arm_mps2_an386"
+#define LOSCFG_DEVICE_COMPANY "qemu"
+#define LOSCFG_PLATFORM_QEMU_ARM_VIRT_CM4 1
+#define LOSCFG_PRODUCT_QEMU_ARM_MPS2_AN386 1
+#define LOSCFG_ARCH_ARM 1
+#define LOSCFG_ARCH_ARM_AARCH32 1
+#define LOSCFG_ARCH_ARM_V7M 1
+#define LOSCFG_ARCH_ARM_VER "armv7-m"
+#define LOSCFG_ARCH_CORTEX_M4 1
+#define LOSCFG_ARCH_CPU "cortex-m4"
+#define LOSCFG_IRQ_USE_STANDALONE_STACK 1
+#define LOSCFG_SOC_COMPANY "goodix"
+#define LOSCFG_BOARD "gr5515_sk"
+#define LOSCFG_BOARD_GR5515_SK 1
+#define LOSCFG_LFS_MAX_BLOCK_COUNT 60
+#define LOSCFG_SOC "gr551x"
+#define LOSCFG_SOC_SERIES "gr551x"
+#define LOSCFG_NUM_IRQS 45
+#define LOSCFG_SYS_CLOCK_HW_CYCLES_PER_SEC 64000000
+#define LOSCFG_SOC_SERIES_GR551x 1
+#define LOSCFG_SOC_COMPANY_GOODIX 1
+#define LOSCFG_SOC_GR551x 1
+#define LOSCFG_KERNEL_EXTKERNEL 1
+#define LOSCFG_KERNEL_BACKTRACE 1
+#define LOSCFG_BACKTRACE_TYPE_1 1
+#define LOSCFG_BACKTRACE_TYPE 1
+#define LOSCFG_BACKTRACE_DEPTH 15
+#define LOSCFG_BASE_CORE_CPUP 1
+#define LOSCFG_KERNEL_CPUP 1
+#define LOSCFG_CPUP_INCLUDE_IRQ 1
+#define LOSCFG_KERNEL_PM 1
+#define LOSCFG_KERNEL_PM_TASK_PTIORITY 1
+#define LOSCFG_KERNEL_PM_TASK_STACKSIZE 1024
+#define LOSCFG_DEBUG_HOOK 1
+#define LOSCFG_PLATFORM_EXC 1
+#define LOSCFG_LIB_LIBC 1
+#define LOSCFG_KAL_CMSIS 1
+#define LOSCFG_LIBC_MUSL 1
+#define LOSCFG_LIBC_MUSL_FS 1
+#define LOSCFG_POSIX_API 1
+#define LOSCFG_POSIX_THREAD_API 1
+#define LOSCFG_POSIX_SEM_API 1
+#define LOSCFG_POSIX_CLOCK_API 1
+#define LOSCFG_POSIX_MQUEUE_API 1
+#define LOSCFG_FS_VFS 1
+#define LOSCFG_FS_LITTLEFS 1
+#define LOSCFG_LFS_MAX_MOUNT_SIZE 3
+#define LOSCFG_SUPPORT_LITTLEFS 1
+#define LOSCFG_GDB 1
+#define LOSCFG_PLATFORM_ADAPT 1
+#define LOSCFG_ENABLE_MAGICKEY 1
+#define LOSCFG_THUMB 1
+#define LOSCFG_DEBUG_VERSION 1
+#define LOSCFG_DRIVERS 1
+#define LOSCFG_DRIVERS_HDF 1
+#define LOSCFG_DRIVERS_HDF_PLATFORM 1
+#define LOSCFG_DRIVERS_HDF_PLATFORM_GPIO 1
+#define LOSCFG_CC_STACKPROTECTOR_STRONG 1
diff --git a/kernel/liteos_m/kal/BUILD.gn b/kernel/liteos_m/kal/BUILD.gn
index 4e59b8e..5f61e71 100644
--- a/kernel/liteos_m/kal/BUILD.gn
+++ b/kernel/liteos_m/kal/BUILD.gn
@@ -34,7 +34,7 @@ module_group(module_name) {
   modules = [
     "cmsis",
     "libc",
-    "libsec",
+    # "libsec",
     "posix",
   ]
 }
diff --git a/test/xts/acts/build_lite/BUILD.gn b/test/xts/acts/build_lite/BUILD.gn
index 2a736bb..0566eb1 100644
--- a/test/xts/acts/build_lite/BUILD.gn
+++ b/test/xts/acts/build_lite/BUILD.gn
@@ -32,8 +32,8 @@ lite_component("acts_component") {
   } else {
     if (ohos_kernel_type == "liteos_m") {
       all_features += [
-        "//test/xts/acts/communication_lite/lwip_hal:ActsLwipTest",
-        "//test/xts/acts/communication_lite/wifiservice_hal:ActsWifiServiceTest",
+        # "//test/xts/acts/communication_lite/lwip_hal:ActsLwipTest",
+        # "//test/xts/acts/communication_lite/wifiservice_hal:ActsWifiServiceTest",
         "//test/xts/acts/utils_lite/file_hal:ActsUtilsFileTest",
         "//test/xts/acts/startup_lite/syspara_hal:ActsParameterTest",
         "//test/xts/acts/iot_hardware_lite/iot_controller_hal:ActsWifiIotTest",
diff --git a/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c b/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
index d592537..5654c58 100755
--- a/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
+++ b/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
@@ -125,7 +125,7 @@ LITE_TEST_CASE(DfxFuncTestSuite, subDfxDftHilog0500, LEVEL1)
  */
 LITE_TEST_CASE(DfxFuncTestSuite, subDfxDftHilog0600, LEVEL0)
 {
-    bool ret = TRUE;
+    BOOL ret = TRUE;
     ret = HiLogRegisterModule(HILOG_MODULE_HIVIEW, "HIVIEW");
     TEST_ASSERT_FALSE(ret);
 };
diff --git a/third_party/mbedtls/library/entropy_poll.c b/third_party/mbedtls/library/entropy_poll.c
index d7062ea..852438a 100755
--- a/third_party/mbedtls/library/entropy_poll.c
+++ b/third_party/mbedtls/library/entropy_poll.c
@@ -14,7 +14,7 @@
  *  not use this file except in compliance with the License.
  *  You may obtain a copy of the License at
  *
- *  http://www.apache.org/licenses/LICENSE-2.0
+ *  http://www.apache.org/licenses/LICENSE-2
  *
  *  Unless required by applicable law or agreed to in writing, software
  *  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
@@ -140,43 +140,24 @@ static int getrandom_wrapper( void *buf, size_t buflen, unsigned int flags )
 #endif /* __linux__ */
 
 #include <stdio.h>
-
+extern int HardwareRandomGet(uint32_t *p_random);
 int mbedtls_platform_entropy_poll( void *data,
                            unsigned char *output, size_t len, size_t *olen )
 {
-    FILE *file;
-    size_t read_len;
     int ret;
     ((void) data);
 
-#if defined(HAVE_GETRANDOM)
-    ret = getrandom_wrapper( output, len, 0 );
-    if( ret >= 0 )
-    {
-        *olen = ret;
-        return( 0 );
-    }
-    else if( errno != ENOSYS )
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
-    /* Fall through if the system call isn't known. */
-#else
-    ((void) ret);
-#endif /* HAVE_GETRANDOM */
-
-    *olen = 0;
-
-    file = fopen( "/dev/urandom", "rb" );
-    if( file == NULL )
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
+    int i = 0;
+    uint32_t tmp_random  = 0;
 
-    read_len = fread( output, 1, len, file );
-    if( read_len != len )
-    {
-        fclose( file );
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
+    for (i = 0; i < len; i++) {
+        ret = HardwareRandomGet(&tmp_random);
+        if (ret != 0) {
+            return -1;
+        }
+        output[i] = tmp_random;
     }
 
-    fclose( file );
     *olen = len;
 
     return( 0 );
diff --git a/third_party/musl/porting/liteos_m/kernel/BUILD.gn b/third_party/musl/porting/liteos_m/kernel/BUILD.gn
index f7ba328..cc2d589 100644
--- a/third_party/musl/porting/liteos_m/kernel/BUILD.gn
+++ b/third_party/musl/porting/liteos_m/kernel/BUILD.gn
@@ -30,8 +30,6 @@
 libc = "musl-c"
 libm = "musl-m"
 
-LITEOS_MENUCONFIG_H = rebase_path("$root_out_dir/config.h")
-
 config("include") {
   include_dirs = [ "include" ]
 }
@@ -63,7 +61,7 @@ static_library(libc) {
     "src/misc/dirname.c",
     "src/multibyte/internal.c",
     "src/multibyte/mbtowc.c",
-    "src/multibyte/wcrtomb.c",
+    # "src/multibyte/wcrtomb.c",
     "src/multibyte/wctomb.c",
     "src/network/h_errno.c",
     "src/network/htonl.c",
@@ -105,25 +103,25 @@ static_library(libc) {
     "src/stdio/perror.c",
     "src/stdio/remove.c",
     "src/stdio/rewind.c",
-    "src/stdio/snprintf.c",
+    # "src/stdio/snprintf.c",
     "src/stdio/stderr.c",
     "src/stdio/stdin.c",
     "src/stdio/stdout.c",
-    "src/stdio/vfprintf.c",
-    "src/stdio/vsnprintf.c",
-    "src/stdio/vsprintf.c",
+    # "src/stdio/vfprintf.c",
+    # "src/stdio/vsnprintf.c",
+    # "src/stdio/vsprintf.c",
     "src/stdlib/abs.c",
     "src/stdlib/atof.c",
     "src/stdlib/atoi.c",
 
     #"src/stdlib/strtol.c",
     "src/locale/iconv.c",
-    "src/stdio/ungetc.c",
+    # "src/stdio/ungetc.c",
     "src/stdlib/atol.c",
     "src/stdlib/atoll.c",
     "src/stdlib/bsearch.c",
     "src/stdlib/llabs.c",
-    "src/stdlib/strtod.c",
+    # "src/stdlib/strtod.c",
     "src/string/memchr.c",
     "src/string/memcmp.c",
     "src/string/memcpy.c",
@@ -131,20 +129,17 @@ static_library(libc) {
     "src/string/memrchr.c",
     "src/string/memset.c",
     "src/string/stpcpy.c",
-    "src/string/stpncpy.c",
     "src/string/strcasecmp.c",
     "src/string/strcat.c",
     "src/string/strchr.c",
     "src/string/strchrnul.c",
     "src/string/strcmp.c",
-    "src/string/strcpy.c",
     "src/string/strcspn.c",
     "src/string/strdup.c",
     "src/string/strlen.c",
     "src/string/strncasecmp.c",
-    "src/string/strncat.c",
     "src/string/strncmp.c",
-    "src/string/strncpy.c",
+    # "src/string/strncpy.c",
     "src/string/strnlen.c",
     "src/string/strrchr.c",
     "src/string/strspn.c",
@@ -175,11 +170,6 @@ static_library(libc) {
     "//kernel/liteos_m/utils",
   ]
 
-  cflags = [
-    "-imacros",
-    "$LITEOS_MENUCONFIG_H",
-  ]
-
   public_configs = [ ":include" ]
 }
 
-- 
2.17.1

