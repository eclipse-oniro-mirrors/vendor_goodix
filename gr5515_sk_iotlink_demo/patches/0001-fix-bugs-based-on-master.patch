From 1d3e4c2ba200271c43ef432ad33c687fbe91a707 Mon Sep 17 00:00:00 2001
From: lidongshan <lidongshan@goodix.com>
Date: Wed, 26 Jan 2022 14:18:53 +0800
Subject: [PATCH] fix-bugs-based-on-master

---
 drivers/adapter/khdf/liteos_m/BUILD.gn        |  2 +-
 test/xts/acts/build_lite/BUILD.gn             |  4 +-
 .../hiviewdfx_lite/hilog_hal/src/dfx_hilog.c  |  2 +-
 third_party/mbedtls/library/entropy_poll.c    | 37 +++++--------------
 .../musl/porting/liteos_m/kernel/BUILD.gn     | 14 +++----
 5 files changed, 20 insertions(+), 39 deletions(-)

diff --git a/drivers/adapter/khdf/liteos_m/BUILD.gn b/drivers/adapter/khdf/liteos_m/BUILD.gn
index a72632b..cac1f1a 100644
--- a/drivers/adapter/khdf/liteos_m/BUILD.gn
+++ b/drivers/adapter/khdf/liteos_m/BUILD.gn
@@ -30,7 +30,7 @@
 group("hdf_lite") {
   deps = [
     "core:hdf_core",
-    "network:hdf_network",
+    # "network:hdf_network",
     "osal:hdf_osal_lite",
     "platform:hdf_platform_lite",
     "test\sample_driver:sample_driver",
diff --git a/test/xts/acts/build_lite/BUILD.gn b/test/xts/acts/build_lite/BUILD.gn
index 7ce3851..6b09691 100644
--- a/test/xts/acts/build_lite/BUILD.gn
+++ b/test/xts/acts/build_lite/BUILD.gn
@@ -32,8 +32,8 @@ lite_component("acts_component") {
   } else {
     if (ohos_kernel_type == "liteos_m") {
       all_features += [
-        "//test/xts/acts/communication_lite/lwip_hal:ActsLwipTest",
-        "//test/xts/acts/communication_lite/wifiservice_hal:ActsWifiServiceTest",
+        # "//test/xts/acts/communication_lite/lwip_hal:ActsLwipTest",
+        # "//test/xts/acts/communication_lite/wifiservice_hal:ActsWifiServiceTest",
         "//test/xts/acts/utils_lite/file_hal:ActsUtilsFileTest",
         "//test/xts/acts/startup_lite/syspara_hal:ActsParameterTest",
         "//test/xts/acts/iot_hardware_lite/iot_controller_hal:ActsWifiIotTest",
diff --git a/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c b/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
index d592537..5654c58 100755
--- a/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
+++ b/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
@@ -125,7 +125,7 @@ LITE_TEST_CASE(DfxFuncTestSuite, subDfxDftHilog0500, LEVEL1)
  */
 LITE_TEST_CASE(DfxFuncTestSuite, subDfxDftHilog0600, LEVEL0)
 {
-    bool ret = TRUE;
+    BOOL ret = TRUE;
     ret = HiLogRegisterModule(HILOG_MODULE_HIVIEW, "HIVIEW");
     TEST_ASSERT_FALSE(ret);
 };
diff --git a/third_party/mbedtls/library/entropy_poll.c b/third_party/mbedtls/library/entropy_poll.c
index d7062ea..6758b5e 100755
--- a/third_party/mbedtls/library/entropy_poll.c
+++ b/third_party/mbedtls/library/entropy_poll.c
@@ -140,43 +140,24 @@ static int getrandom_wrapper( void *buf, size_t buflen, unsigned int flags )
 #endif /* __linux__ */
 
 #include <stdio.h>
-
+extern int HardwareRandomGet(uint32_t *p_random);
 int mbedtls_platform_entropy_poll( void *data,
                            unsigned char *output, size_t len, size_t *olen )
 {
-    FILE *file;
-    size_t read_len;
     int ret;
     ((void) data);
 
-#if defined(HAVE_GETRANDOM)
-    ret = getrandom_wrapper( output, len, 0 );
-    if( ret >= 0 )
-    {
-        *olen = ret;
-        return( 0 );
-    }
-    else if( errno != ENOSYS )
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
-    /* Fall through if the system call isn't known. */
-#else
-    ((void) ret);
-#endif /* HAVE_GETRANDOM */
-
-    *olen = 0;
-
-    file = fopen( "/dev/urandom", "rb" );
-    if( file == NULL )
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
+    int i = 0;
+    uint32_t tmp_random  = 0;
 
-    read_len = fread( output, 1, len, file );
-    if( read_len != len )
-    {
-        fclose( file );
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
+    for (i = 0; i < len; i++) {
+        ret = HardwareRandomGet(&tmp_random);
+        if (ret != 0) {
+            return -1;
+        }
+        output[i] = tmp_random;
     }
 
-    fclose( file );
     *olen = len;
 
     return( 0 );
diff --git a/third_party/musl/porting/liteos_m/kernel/BUILD.gn b/third_party/musl/porting/liteos_m/kernel/BUILD.gn
index 664f949..c2ed857 100644
--- a/third_party/musl/porting/liteos_m/kernel/BUILD.gn
+++ b/third_party/musl/porting/liteos_m/kernel/BUILD.gn
@@ -60,7 +60,7 @@ static_library(libc) {
     "src/misc/dirname.c",
     "src/multibyte/internal.c",
     "src/multibyte/mbtowc.c",
-    "src/multibyte/wcrtomb.c",
+    # "src/multibyte/wcrtomb.c",
     "src/multibyte/wctomb.c",
     "src/network/h_errno.c",
     "src/network/htonl.c",
@@ -102,25 +102,25 @@ static_library(libc) {
     "src/stdio/perror.c",
     "src/stdio/remove.c",
     "src/stdio/rewind.c",
-    "src/stdio/snprintf.c",
+    # "src/stdio/snprintf.c",
     "src/stdio/stderr.c",
     "src/stdio/stdin.c",
     "src/stdio/stdout.c",
-    "src/stdio/vfprintf.c",
-    "src/stdio/vsnprintf.c",
-    "src/stdio/vsprintf.c",
+    # "src/stdio/vfprintf.c",
+    # "src/stdio/vsnprintf.c",
+    # "src/stdio/vsprintf.c",
     "src/stdlib/abs.c",
     "src/stdlib/atof.c",
     "src/stdlib/atoi.c",
 
     #"src/stdlib/strtol.c",
     "src/locale/iconv.c",
-    "src/stdio/ungetc.c",
+    # "src/stdio/ungetc.c",
     "src/stdlib/atol.c",
     "src/stdlib/atoll.c",
     "src/stdlib/bsearch.c",
     "src/stdlib/llabs.c",
-    "src/stdlib/strtod.c",
+    # "src/stdlib/strtod.c",
     "src/string/memchr.c",
     "src/string/memcmp.c",
     "src/string/memcpy.c",
-- 
2.17.1

