From c74cc562f2990096b7aeb5188ab13c78992efd26 Mon Sep 17 00:00:00 2001
From: lidongshan <lidongshan@goodix.com>
Date: Tue, 14 Dec 2021 13:37:46 +0800
Subject: [PATCH] fix-bugs-based-on-master

---
 drivers/adapter/khdf/liteos_m/hdf.gni         |  2 +-
 .../hiviewdfx_lite/hilog_hal/src/dfx_hilog.c  |  2 +-
 third_party/mbedtls/library/entropy_poll.c    | 39 +++++--------------
 .../musl/porting/liteos_m/kernel/BUILD.gn     | 28 +++++--------
 4 files changed, 21 insertions(+), 50 deletions(-)

diff --git a/drivers/adapter/khdf/liteos_m/hdf.gni b/drivers/adapter/khdf/liteos_m/hdf.gni
index b1b631b..a8f0657 100755
--- a/drivers/adapter/khdf/liteos_m/hdf.gni
+++ b/drivers/adapter/khdf/liteos_m/hdf.gni
@@ -79,5 +79,5 @@ template("hdf_driver") {
 
 set_defaults("hdf_driver") {
   configs = [ "$HDFTOPDIR:hdf_config" ]
-  visibility = [ "$HDFTOPDIR:*" ]
+  # visibility = [ "$HDFTOPDIR:*" ]
 }
diff --git a/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c b/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
index d592537..5654c58 100755
--- a/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
+++ b/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
@@ -125,7 +125,7 @@ LITE_TEST_CASE(DfxFuncTestSuite, subDfxDftHilog0500, LEVEL1)
  */
 LITE_TEST_CASE(DfxFuncTestSuite, subDfxDftHilog0600, LEVEL0)
 {
-    bool ret = TRUE;
+    BOOL ret = TRUE;
     ret = HiLogRegisterModule(HILOG_MODULE_HIVIEW, "HIVIEW");
     TEST_ASSERT_FALSE(ret);
 };
diff --git a/third_party/mbedtls/library/entropy_poll.c b/third_party/mbedtls/library/entropy_poll.c
index d7062ea..852438a 100755
--- a/third_party/mbedtls/library/entropy_poll.c
+++ b/third_party/mbedtls/library/entropy_poll.c
@@ -14,7 +14,7 @@
  *  not use this file except in compliance with the License.
  *  You may obtain a copy of the License at
  *
- *  http://www.apache.org/licenses/LICENSE-2.0
+ *  http://www.apache.org/licenses/LICENSE-2
  *
  *  Unless required by applicable law or agreed to in writing, software
  *  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
@@ -140,43 +140,24 @@ static int getrandom_wrapper( void *buf, size_t buflen, unsigned int flags )
 #endif /* __linux__ */
 
 #include <stdio.h>
-
+extern int HardwareRandomGet(uint32_t *p_random);
 int mbedtls_platform_entropy_poll( void *data,
                            unsigned char *output, size_t len, size_t *olen )
 {
-    FILE *file;
-    size_t read_len;
     int ret;
     ((void) data);
 
-#if defined(HAVE_GETRANDOM)
-    ret = getrandom_wrapper( output, len, 0 );
-    if( ret >= 0 )
-    {
-        *olen = ret;
-        return( 0 );
-    }
-    else if( errno != ENOSYS )
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
-    /* Fall through if the system call isn't known. */
-#else
-    ((void) ret);
-#endif /* HAVE_GETRANDOM */
-
-    *olen = 0;
-
-    file = fopen( "/dev/urandom", "rb" );
-    if( file == NULL )
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
+    int i = 0;
+    uint32_t tmp_random  = 0;
 
-    read_len = fread( output, 1, len, file );
-    if( read_len != len )
-    {
-        fclose( file );
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
+    for (i = 0; i < len; i++) {
+        ret = HardwareRandomGet(&tmp_random);
+        if (ret != 0) {
+            return -1;
+        }
+        output[i] = tmp_random;
     }
 
-    fclose( file );
     *olen = len;
 
     return( 0 );
diff --git a/third_party/musl/porting/liteos_m/kernel/BUILD.gn b/third_party/musl/porting/liteos_m/kernel/BUILD.gn
index f7ba328..1fb102e 100644
--- a/third_party/musl/porting/liteos_m/kernel/BUILD.gn
+++ b/third_party/musl/porting/liteos_m/kernel/BUILD.gn
@@ -30,8 +30,6 @@
 libc = "musl-c"
 libm = "musl-m"
 
-LITEOS_MENUCONFIG_H = rebase_path("$root_out_dir/config.h")
-
 config("include") {
   include_dirs = [ "include" ]
 }
@@ -63,7 +61,7 @@ static_library(libc) {
     "src/misc/dirname.c",
     "src/multibyte/internal.c",
     "src/multibyte/mbtowc.c",
-    "src/multibyte/wcrtomb.c",
+    # "src/multibyte/wcrtomb.c",
     "src/multibyte/wctomb.c",
     "src/network/h_errno.c",
     "src/network/htonl.c",
@@ -105,46 +103,43 @@ static_library(libc) {
     "src/stdio/perror.c",
     "src/stdio/remove.c",
     "src/stdio/rewind.c",
-    "src/stdio/snprintf.c",
+    # "src/stdio/snprintf.c",
     "src/stdio/stderr.c",
     "src/stdio/stdin.c",
     "src/stdio/stdout.c",
-    "src/stdio/vfprintf.c",
-    "src/stdio/vsnprintf.c",
-    "src/stdio/vsprintf.c",
+    # "src/stdio/vfprintf.c",
+    # "src/stdio/vsnprintf.c",
+    # "src/stdio/vsprintf.c",
     "src/stdlib/abs.c",
     "src/stdlib/atof.c",
     "src/stdlib/atoi.c",
 
     #"src/stdlib/strtol.c",
     "src/locale/iconv.c",
-    "src/stdio/ungetc.c",
+    # "src/stdio/ungetc.c",
     "src/stdlib/atol.c",
     "src/stdlib/atoll.c",
     "src/stdlib/bsearch.c",
     "src/stdlib/llabs.c",
-    "src/stdlib/strtod.c",
+    # "src/stdlib/strtod.c",
     "src/string/memchr.c",
     "src/string/memcmp.c",
-    "src/string/memcpy.c",
+    # "src/string/memcpy.c",
     "src/string/memmove.c",
     "src/string/memrchr.c",
     "src/string/memset.c",
     "src/string/stpcpy.c",
-    "src/string/stpncpy.c",
     "src/string/strcasecmp.c",
     "src/string/strcat.c",
     "src/string/strchr.c",
     "src/string/strchrnul.c",
     "src/string/strcmp.c",
-    "src/string/strcpy.c",
     "src/string/strcspn.c",
     "src/string/strdup.c",
     "src/string/strlen.c",
     "src/string/strncasecmp.c",
-    "src/string/strncat.c",
     "src/string/strncmp.c",
-    "src/string/strncpy.c",
+    # "src/string/strncpy.c",
     "src/string/strnlen.c",
     "src/string/strrchr.c",
     "src/string/strspn.c",
@@ -175,11 +170,6 @@ static_library(libc) {
     "//kernel/liteos_m/utils",
   ]
 
-  cflags = [
-    "-imacros",
-    "$LITEOS_MENUCONFIG_H",
-  ]
-
   public_configs = [ ":include" ]
 }
 
-- 
2.17.1

