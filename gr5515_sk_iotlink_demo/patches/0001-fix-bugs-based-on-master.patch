From 10acd1cb30ac0c978dc84e2e2f6710c6f17be809 Mon Sep 17 00:00:00 2001
From: lidongshan <lidongshan@goodix.com>
Date: Tue, 16 Nov 2021 10:59:38 +0800
Subject: [PATCH] fix-bugs-based-on-master

---
 build/lite/config/component/openssl/BUILD.gn  |  2 +-
 kernel/liteos_m/kal/cmsis/cmsis_liteos2.c     | 26 +++++++++++++
 kernel/liteos_m/kal/posix/src/pthread.c       |  1 +
 .../arch/arm/cortex-m4/gcc/los_interrupt.c    |  4 +-
 test/xts/acts/build_lite/BUILD.gn             |  4 +-
 .../hiviewdfx_lite/hilog_hal/src/dfx_hilog.c  |  2 +-
 .../tools/lite/hctest/src/hctest_service.c    |  2 +-
 third_party/mbedtls/library/entropy_poll.c    | 37 +++++--------------
 .../musl/porting/liteos_m/kernel/BUILD.gn     | 14 +++----
 9 files changed, 50 insertions(+), 42 deletions(-)

diff --git a/build/lite/config/component/openssl/BUILD.gn b/build/lite/config/component/openssl/BUILD.gn
index ecba772..2433a17 100755
--- a/build/lite/config/component/openssl/BUILD.gn
+++ b/build/lite/config/component/openssl/BUILD.gn
@@ -24,7 +24,7 @@ config("openssl_config") {
   ]
 
   cflags = [
-    "-fPIC",
+    #"-fPIC",
     "-DOPENSSL_ARM_PLATFORM",
   ]
 }
diff --git a/kernel/liteos_m/kal/cmsis/cmsis_liteos2.c b/kernel/liteos_m/kal/cmsis/cmsis_liteos2.c
index 48ba88d..c672f5c 100644
--- a/kernel/liteos_m/kal/cmsis/cmsis_liteos2.c
+++ b/kernel/liteos_m/kal/cmsis/cmsis_liteos2.c
@@ -1129,6 +1129,7 @@ osStatus_t osMutexDelete(osMutexId_t mutex_id)
 
 osSemaphoreId_t osSemaphoreNew(uint32_t max_count, uint32_t initial_count, const osSemaphoreAttr_t *attr)
 {
+ #if 0
     UINT32 uwRet = LOS_NOK;
     UINT32 uwSemId;
     UINT32 intSave;
@@ -1152,6 +1153,31 @@ osSemaphoreId_t osSemaphoreNew(uint32_t max_count, uint32_t initial_count, const
     } else {
         return (osSemaphoreId_t)NULL;
     }
+
+#else
+
+    UINT32 uwRet;
+    UINT32 uwSemId;
+
+    UNUSED(attr);
+
+    if (OS_INT_ACTIVE) {
+        return (osSemaphoreId_t)NULL;
+    }
+
+    if (1 == max_count) {
+        uwRet = LOS_BinarySemCreate((UINT16)initial_count, &uwSemId);
+    } else {
+        uwRet = LOS_SemCreate((UINT16)initial_count, &uwSemId);
+    }
+
+    if (uwRet == LOS_OK) {
+        return (osSemaphoreId_t)(GET_SEM(uwSemId));
+    } else {
+        return (osSemaphoreId_t)NULL;
+    }
+
+#endif
 }
 
 
diff --git a/kernel/liteos_m/kal/posix/src/pthread.c b/kernel/liteos_m/kal/posix/src/pthread.c
index e126392..eee39b1 100644
--- a/kernel/liteos_m/kal/posix/src/pthread.c
+++ b/kernel/liteos_m/kal/posix/src/pthread.c
@@ -124,6 +124,7 @@ int pthread_create(pthread_t *thread, const pthread_attr_t *attr,
         return ret;
     }
 
+    ((pthread_attr_t *)attr)->stacksize *= 2;
     if (LOS_TaskCreateOnly(&taskID, &taskInitParam) != LOS_OK) {
         free((VOID *)(UINTPTR)taskInitParam.uwArg);
         return EINVAL;
diff --git a/kernel/liteos_m/kernel/arch/arm/cortex-m4/gcc/los_interrupt.c b/kernel/liteos_m/kernel/arch/arm/cortex-m4/gcc/los_interrupt.c
index 6ab3518..b15f986 100644
--- a/kernel/liteos_m/kernel/arch/arm/cortex-m4/gcc/los_interrupt.c
+++ b/kernel/liteos_m/kernel/arch/arm/cortex-m4/gcc/los_interrupt.c
@@ -484,7 +484,7 @@ LITE_OS_SEC_TEXT_INIT VOID HalExcHandleEntry(UINT32 excType, UINT32 faultAddr, U
     OsExcInfoDisplay(&g_excInfo);
     HalSysExit();
 }
-
+#if 0
 /* stack protector */
 WEAK UINT32 __stack_chk_guard = 0xd00a0dff;
 
@@ -494,7 +494,7 @@ WEAK VOID __stack_chk_fail(VOID)
     LOS_Panic("stack-protector: Kernel stack is corrupted in: %p\n",
               __builtin_return_address(0));
 }
-
+#endif
 /* ****************************************************************************
  Function    : HalHwiInit
  Description : initialization of the hardware interrupt
diff --git a/test/xts/acts/build_lite/BUILD.gn b/test/xts/acts/build_lite/BUILD.gn
index 803a06c..e70b746 100644
--- a/test/xts/acts/build_lite/BUILD.gn
+++ b/test/xts/acts/build_lite/BUILD.gn
@@ -32,8 +32,8 @@ lite_component("acts_component") {
   } else {
     if (ohos_kernel_type == "liteos_m") {
       all_features += [
-        "//test/xts/acts/communication_lite/lwip_hal:ActsLwipTest",
-        "//test/xts/acts/communication_lite/wifiservice_hal:ActsWifiServiceTest",
+        #"//test/xts/acts/communication_lite/lwip_hal:ActsLwipTest",
+        #"//test/xts/acts/communication_lite/wifiservice_hal:ActsWifiServiceTest",
         "//test/xts/acts/utils_lite/file_hal:ActsUtilsFileTest",
         "//test/xts/acts/startup_lite/syspara_hal:ActsParameterTest",
         "//test/xts/acts/iot_hardware_lite/iot_controller_hal:ActsWifiIotTest",
diff --git a/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c b/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
index d592537..5654c58 100755
--- a/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
+++ b/test/xts/acts/hiviewdfx_lite/hilog_hal/src/dfx_hilog.c
@@ -125,7 +125,7 @@ LITE_TEST_CASE(DfxFuncTestSuite, subDfxDftHilog0500, LEVEL1)
  */
 LITE_TEST_CASE(DfxFuncTestSuite, subDfxDftHilog0600, LEVEL0)
 {
-    bool ret = TRUE;
+    BOOL ret = TRUE;
     ret = HiLogRegisterModule(HILOG_MODULE_HIVIEW, "HIVIEW");
     TEST_ASSERT_FALSE(ret);
 };
diff --git a/test/xts/tools/lite/hctest/src/hctest_service.c b/test/xts/tools/lite/hctest/src/hctest_service.c
index e997fbc..65e89c6 100644
--- a/test/xts/tools/lite/hctest/src/hctest_service.c
+++ b/test/xts/tools/lite/hctest/src/hctest_service.c
@@ -87,7 +87,7 @@ static BOOL MessageHandle(Service *service, Request *request)
 
 static TaskConfig GetTaskConfig(Service *service)
 {
-    TaskConfig config = {LEVEL_MIDDLE, PRI_NORMAL, 0x1000, TASK_QUEUE_SIZE, SINGLE_TASK};
+    TaskConfig config = {LEVEL_MIDDLE, PRI_NORMAL, 0x4000, TASK_QUEUE_SIZE, SINGLE_TASK};
     (void)service;
     return config;
 };
diff --git a/third_party/mbedtls/library/entropy_poll.c b/third_party/mbedtls/library/entropy_poll.c
index d7062ea..6758b5e 100755
--- a/third_party/mbedtls/library/entropy_poll.c
+++ b/third_party/mbedtls/library/entropy_poll.c
@@ -140,43 +140,24 @@ static int getrandom_wrapper( void *buf, size_t buflen, unsigned int flags )
 #endif /* __linux__ */
 
 #include <stdio.h>
-
+extern int HardwareRandomGet(uint32_t *p_random);
 int mbedtls_platform_entropy_poll( void *data,
                            unsigned char *output, size_t len, size_t *olen )
 {
-    FILE *file;
-    size_t read_len;
     int ret;
     ((void) data);
 
-#if defined(HAVE_GETRANDOM)
-    ret = getrandom_wrapper( output, len, 0 );
-    if( ret >= 0 )
-    {
-        *olen = ret;
-        return( 0 );
-    }
-    else if( errno != ENOSYS )
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
-    /* Fall through if the system call isn't known. */
-#else
-    ((void) ret);
-#endif /* HAVE_GETRANDOM */
-
-    *olen = 0;
-
-    file = fopen( "/dev/urandom", "rb" );
-    if( file == NULL )
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
+    int i = 0;
+    uint32_t tmp_random  = 0;
 
-    read_len = fread( output, 1, len, file );
-    if( read_len != len )
-    {
-        fclose( file );
-        return( MBEDTLS_ERR_ENTROPY_SOURCE_FAILED );
+    for (i = 0; i < len; i++) {
+        ret = HardwareRandomGet(&tmp_random);
+        if (ret != 0) {
+            return -1;
+        }
+        output[i] = tmp_random;
     }
 
-    fclose( file );
     *olen = len;
 
     return( 0 );
diff --git a/third_party/musl/porting/liteos_m/kernel/BUILD.gn b/third_party/musl/porting/liteos_m/kernel/BUILD.gn
index b0cead9..41656d5 100644
--- a/third_party/musl/porting/liteos_m/kernel/BUILD.gn
+++ b/third_party/musl/porting/liteos_m/kernel/BUILD.gn
@@ -60,7 +60,7 @@ static_library(libc) {
     "src/misc/dirname.c",
     "src/multibyte/internal.c",
     "src/multibyte/mbtowc.c",
-    "src/multibyte/wcrtomb.c",
+    #"src/multibyte/wcrtomb.c",
     "src/multibyte/wctomb.c",
     "src/network/h_errno.c",
     "src/network/htonl.c",
@@ -102,25 +102,25 @@ static_library(libc) {
     "src/stdio/perror.c",
     "src/stdio/remove.c",
     "src/stdio/rewind.c",
-    "src/stdio/snprintf.c",
+    #"src/stdio/snprintf.c",
     "src/stdio/stderr.c",
     "src/stdio/stdin.c",
     "src/stdio/stdout.c",
-    "src/stdio/vfprintf.c",
-    "src/stdio/vsnprintf.c",
-    "src/stdio/vsprintf.c",
+    #"src/stdio/vfprintf.c",
+    #"src/stdio/vsnprintf.c",
+    #"src/stdio/vsprintf.c",
     "src/stdlib/abs.c",
     "src/stdlib/atof.c",
     "src/stdlib/atoi.c",
 
     #"src/stdlib/strtol.c",
     "src/locale/iconv.c",
-    "src/stdio/ungetc.c",
+    #"src/stdio/ungetc.c",
     "src/stdlib/atol.c",
     "src/stdlib/atoll.c",
     "src/stdlib/bsearch.c",
     "src/stdlib/llabs.c",
-    "src/stdlib/strtod.c",
+    #"src/stdlib/strtod.c",
     "src/string/memchr.c",
     "src/string/memcmp.c",
     "src/string/memcpy.c",
-- 
2.17.1

